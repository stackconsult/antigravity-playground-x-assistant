name: Agentic Verification

on:
  push:
    branches: ["main", "feature/**"]
  pull_request:
    branches: ["main"]

jobs:
  agent-verify:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Use Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "24.x"

      - name: 1. Integrity Gate (Deep Diagnostics)
        run: |
          echo "üìÅ Checking Core Infrastructure..."
          for dir in .antigravity .antigravity/context .antigravity/skills .github/workflows docs src tests; do
            if [ ! -d "$dir" ]; then echo "‚ùå $dir missing"; exit 1; fi
            echo "‚úÖ $dir"
          done

      - name: 2. Governance Gate (Required Files)
        run: |
          echo "üìÑ Checking Legal & Governance Files..."
          for file in AGENTS.md README.md LICENSE CONTRIBUTING.md CHANGELOG.md .gitignore .env.example; do
            if [ ! -f "$file" ]; then echo "‚ùå $file missing"; exit 1; fi
            echo "‚úÖ $file"
          done

      - name: 3. Vision Gate (Active Vision Check)
        run: |
          if grep -q "PENDING INPUT..." AGENTS.md || grep -q "Vision: DEFINED" AGENTS.md; then
            # 'Vision: DEFINED' is the pass state from our local check, adjusting for GitHub Actions
            if grep -q "Vision: DEFINED" AGENTS.md; then echo "‚úÖ Vision Defined"; else echo "‚ùå Vision Pending"; exit 1; fi
          fi

      - name: 4. Style Gate (Lint & Format)
        run: |
          npm install
          npm run lint
          npm run format -- --check

      - name: 5. Logic Gate (Tests)
        run: |
          npm test

      - name: 6. Boot Gate (Kernel Operation)
        run: |
          node src/index.js
